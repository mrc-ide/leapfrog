test_that("stratified HIV population equals single-age HIV population", {

  parameters <- read_parameters(test_path("testdata/child_parms_full.h5"))
  out_full <- run_model(parameters, "HivFullAgeStratification")
  out_coarse <- run_model(parameters, "HivCoarseAgeStratification") 
  out_child <- run_model(parameters, "ChildModel")

  expect_equal(colSums(out_full$p_hivpop[16:81,,]),
               colSums(out_full$h_hivpop,,2) + colSums(out_full$h_artpop,,3))

  expect_equal(colSums(out_coarse$p_hivpop[16:81,,]),
               colSums(out_coarse$h_hivpop,,2) + colSums(out_coarse$h_artpop,,3))

  expect_equal(colSums(out_child$p_hivpop[16:81,,]),
               colSums(out_child$h_hivpop,,2) + colSums(out_child$h_artpop,,3))

})
                 
test_that("Transmission rate models produces expected epidemics", {

  parameters <- read_parameters(test_path("testdata/child_parms_full.h5"))

  ## Set transmission rate model parameters
  rvec_ts <- c(0.527886533459584, 0.52786693455581, 0.527846774400037, 0.527826036963204,
             0.527804705760995, 0.527782763841058, 0.527760193769874, 0.527736977619261,
             0.527713096952516, 0.527688532810174, 0.527663265695378, 0.527637275558861,
             0.527610541783505, 0.527583043168494, 0.527554757913029, 0.527525663599615,
             0.527495737176882, 0.527464954941953, 0.527433292522341, 0.527400724857353,
             0.527367226179002, 0.527332769992404, 0.527297329055664, 0.527260875359213,
             0.52722338010461, 0.527184813682778, 0.527145145651663, 0.527104344713314,
             0.527062378690355, 0.527019214501846, 0.526974818138508, 0.526929154637315,
             0.526882188055418, 0.526833881443399, 0.526784196817839, 0.52673309513318,
             0.526680536252867, 0.526626478919758, 0.526570880725783, 0.526513698080838,
             0.526454886180893, 0.526394398975303, 0.52633218913331, 0.526268208009705,
             0.526202405609651, 0.526134730552635, 0.526065130035542, 0.525993549794836,
             0.525919934067821, 0.525844225552975, 0.525766365369338, 0.525686293014935,
             0.525603946324221, 0.525519261424534, 0.525432172691525, 0.525342612703578,
             0.525250512195177, 0.525155800009213, 0.525058403048231, 0.524958246224582,
             0.524855252409473, 0.524749342380916, 0.524640434770535, 0.524528446009253,
             0.524413290271814, 0.524294879420161, 0.524173122945632, 0.524047927909992,
             0.523919198885273, 0.523786837892425, 0.52365074433878, 0.523510814954304,
             0.523366943726667, 0.523219021835095, 0.52306693758304, 0.522910576329645,
             0.522749820420022, 0.522584549114352, 0.522414638515814, 0.522239961497351,
             0.5220603876273, 0.521875783093895, 0.521686010628666, 0.521490929428764,
             0.521290395078236, 0.521084259468284, 0.520872370716542, 0.520654573085411,
             0.520430706899511, 0.52020060846227, 0.519964109971742, 0.519721039435681,
             0.519471220585959, 0.519214472792394, 0.518950610976058, 0.518679445522169,
             0.518400782192634, 0.518114422038368, 0.517820161311481, 0.517517791377449,
             0.517207098627404, 0.516887864390664, 0.516559864847656, 0.516222870943381,
             0.51587664830158, 0.515520957139785, 0.515155552185434, 0.514780182593246,
             0.514394591864084, 0.513998517765492, 0.513591692254193, 0.513173841400748,
             0.512744685316681, 0.512303938084332, 0.511851307689729, 0.511386495958814,
             0.510909198497322, 0.510419104634685, 0.50991589737232, 0.509399253336662,
             0.508868842737381, 0.508324329331167, 0.507765370391551, 0.507191616685214,
             0.506602712455245, 0.5059982954119, 0.505377996731324, 0.504741441062835,
             0.504088246545308, 0.50341802483325, 0.502730381133196, 0.502024914251029,
             0.501301216650913, 0.500558874526499, 0.499797467885085, 0.499016570645502,
             0.498215750750403, 0.497394570293763, 0.496552585664359, 0.495689347706,
             0.494804401895377, 0.493897288538297, 0.492967542985209, 0.492014695866841,
             0.491038273350817, 0.49003779742016, 0.489012786174519, 0.487962754155046,
             0.486887212693793, 0.485785670288486, 0.484657633003608, 0.483502604898583,
             0.482320088483978, 0.481109585206519, 0.479870595963699, 0.478602621648831,
             0.477305163727182, 0.475977724843974, 0.474619809464861, 0.473230924549445,
             0.471810580258434, 0.470358290694822, 0.468873574679527, 0.467355956561773,
             0.465804967064368, 0.464220144164052, 0.462601034006814, 0.460947191858086,
             0.459258183087545, 0.457533584188032, 0.45577298382812, 0.453975983937488,
             0.452142200824273, 0.450271266323283, 0.448362828973718, 0.446416555225044,
             0.444432130669151, 0.442409261297003, 0.440347674777574, 0.438247121756607,
             0.436107377172704, 0.433928241587682, 0.431709542528179, 0.429451135835048,
             0.427152907016814, 0.424814772603381, 0.422436681495628, 0.420018616306571,
             0.417560594689302, 0.415062670646689, 0.412524935817748, 0.409947520735089,
             0.407330596047889, 0.404674373704483, 0.401979108088467, 0.399245097102226,
             0.396472683191376, 0.393662254303801, 0.390814244776683, 0.387929136144863,
             0.385007457864103, 0.382049787942468, 0.379056753473476, 0.37602903106457,
             0.372967347154579, 0.369872478214308, 0.366745250824268, 0.36358654162422,
             0.360397277129349, 0.357178433408264, 0.353931035618747, 0.350656157397266,
             0.347354920099268, 0.344028491887569, 0.340678086666866, 0.337304962863327,
             0.33391042204856, 0.330495807408455, 0.327062502057946, 0.323611927203575,
             0.320145540156875, 0.316664832202059, 0.313171326322795, 0.309666574793479,
             0.30615215664132, 0.302629674986666, 0.299100754269456, 0.29556703737091,
             0.292030182640114, 0.288491860835862, 0.284953751995109, 0.281417542239578,
             0.277884920533046, 0.274357575402057, 0.270837191633202, 0.267325446960715,
             0.263824008757913, 0.260334530746568, 0.256858649738084, 0.253397982420256,
             0.249954122203508, 0.246528636139815, 0.243123061927568, 0.239738905014911,
             0.236377635813529, 0.233040687034473, 0.229729451156496, 0.226445278036951,
             0.223189472674198, 0.219963293129515, 0.21676794861581, 0.213604597758962,
             0.210474347037013, 0.20737824940105, 0.204317303080558, 0.201292450575165,
             0.198304577833214, 0.195354513616937, 0.192443029052688, 0.18957083736371,
             0.186738593782158, 0.183946895635843, 0.181196282604642, 0.178487237140518,
             0.175820185044366, 0.173195496192453, 0.170613485404336, 0.168074413443948,
             0.165578488144927, 0.163125865650936, 0.160716651761645, 0.158350903374568,
             0.156028630013148, 0.153749795431238, 0.151514319284213, 0.149322078857175,
             0.147172910840634, 0.145066613144546, 0.143002946741653, 0.140981637531442,
             0.139002378216502, 0.137064830183257, 0.135168625379678, 0.13331336818289,
             0.131498637250058, 0.129723987346539, 0.127988951145588, 0.126293040994565,
             0.124635750642999, 0.123016556928303, 0.121434921415581, 0.119890291988214,
             0.118382104386568, 0.116909783692486, 0.115472745757637, 0.114070398574327,
             0.112702143587558, 0.111367376947661, 0.110065490703049, 0.108795873932952,
             0.107557913820366, 0.106350996665567, 0.105174508840925, 0.104027837687861,
             0.102910372356994, 0.101821504592774, 0.100760629463912, 0.0997271460411586,
             0.0987204580240368, 0.0977399743181983, 0.0967851095652314, 0.0958552846266821,
             0.0949499270242101, 0.094068471337752, 0.0932103595635786, 0.0923750414342094,
             0.0915619747020286, 0.0907706253885386, 0.0900004680010955, 0.0892509857189405,
             0.0885216705503661, 0.0878120234627152, 0.0871215544869602, 0.0864497827984952,
             0.0857962367757251, 0.0851604540380307, 0.084541981464544, 0.0839403751951961,
             0.0833552006153802, 0.0827860323255186, 0.0822324540968049, 0.0816940588142588,
             0.0811704484082454, 0.0806612337755016, 0.0801660346906608, 0.0796844797092468,
             0.0792162060629912, 0.0787608595483389, 0.0783180944089102, 0.0778875732126449,
             0.077468966724338, 0.0770619537741754, 0.0766662211228899, 0.0762814633240783,
             0.0759073825841852, 0.0755436886206483, 0.0755436886206483, 0.0751983225075684,
             0.0748705714567121, 0.0745597530109216, 0.0742652136032474, 0.0739863271937759,
             0.0737224939796408, 0.0734731391740075, 0.0732377118500372, 0.0730156838460782,
             0.0728708815787771, 0.0727446202296157, 0.0726364348319614, 0.0725458854807817,
             0.0724725562103257, 0.0724160539360534, 0.0723760074570253, 0.0723520665152279,
             0.0723439009085211, 0.0723511996541091, 0.0723710074301271, 0.0724055762888202,
             0.0724546464619776, 0.0725179743821334, 0.0725953320599808, 0.072686506497172,
             0.072791299132553, 0.0729095253200181, 0.0730410138362762, 0.073185606416928,
             0.0732594786193342, 0.0733430915005717, 0.0734362693213973, 0.07353884583497,
             0.0736506639363493, 0.0737715753293749, 0.0739014402100169, 0.0740401269653455,
             0.074187511887319, 0.0743434789006339, 0.0744224503749037, 0.0745073575012638,
             0.0745980697242786, 0.0746944624636765, 0.0747964168970734, 0.0749038197519798,
             0.0750165631066415, 0.0751345441992871, 0.0752576652453842, 0.0753858332625237,
             0.075472841132549, 0.0755599870647477, 0.0756472336214014, 0.0757345809186975,
             0.075822029072958, 0.075909578200639, 0.0759972284183311, 0.0760849798427594,
             0.076172832590784, 0.0762607867793998, 0.0762586515072639, 0.0762565162949148,
             0.0762543811423508, 0.0762522460495703, 0.0762501110165715, 0.0762479760433528,
             0.0762458411299125, 0.076243706276249, 0.0762415714823605, 0.0762394367482454,
             0.0763635792743948, 0.0764879239448339, 0.0766124710887193, 0.0767372210357435,
             0.0768621741161356, 0.0769873306606628, 0.0771126910006305, 0.0772382554678839,
             0.0773640243948083, 0.0774899981143304, 0.0774860462252006, 0.077482094537612,
             0.0774781430515544, 0.0774741917670173, 0.0774702406839907, 0.0774662898024641,
             0.0774623391224274, 0.0774583886438702, 0.0774544383667823, 0.0774504882911534,
             0.0775620197714585, 0.0776737118610946, 0.0777855647913446, 0.077897578793825,
             0.0780097541004855, 0.0781220909436099, 0.0782345895558164, 0.0783472501700585,
             0.0784600730196247, 0.0785730583381399, 0.0784994698640612, 0.0784259503100886,
             0.0783524996116742, 0.0782791177043306, 0.0782058045236307, 0.0781325600052078,
             0.0780593840847555, 0.0779862766980276, 0.0779132377808381, 0.077840267269061,
             0.0777519686846363, 0.0776637702622522, 0.0775756718882893, 0.0774876734492571,
             0.0773997748317937, 0.0773119759226659, 0.077224276608769, 0.0771366767771265,
             0.0770491763148902, 0.0769617751093396, 0.0772464431569032, 0.077532164141424,
             0.0778189419575303, 0.078106780514256, 0.0783956837350936, 0.0786856555580483,
             0.078976699935691, 0.0792688208352124, 0.0795620222384775, 0.0798563081420792,
             0.0810598581646867, 0.0822815474262676, 0.0835216493113794, 0.0847804413248805,
             0.0860582051540284, 0.087355226731515, 0.0886717962994512, 0.0900082084743163,
             0.0913647623128858, 0.0927417613791532, 0.0928162629219068, 0.0928908243134253,
             0.0929654456017865, 0.093040126835107, 0.0931148680615419, 0.0931896693292849,
             0.0932645306865686, 0.0933394521816644, 0.0934144338628822, 0.0934894757785709,
             0.0937163691515283, 0.093943813181148, 0.0941718092038408, 0.094400358559261,
             0.094629462590314, 0.0948591226431643, 0.0950893400672439, 0.0953201162152592,
             0.0955514524431999, 0.0957833501103466, 0.0954441129467516, 0.0951060772639258,
             0.0947692388065688, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511, 0.0944335933344511, 0.0944335933344511,
             0.0944335933344511, 0.0944335933344511)

  parameters$incidence_model_choice <- 1L  ## INCIDMOD_TRANSMRATE
  parameters$transmission_rate_hts <- rvec_ts
  parameters$initial_incidence <- 0.00136491
  parameters$relative_infectiousness_art <- 0.3
  parameters$epidemic_start_hts <- 50L


  mod_full <- run_model(parameters, configuration = "HivFullAgeStratification")
  mod_coarse <- run_model(parameters, configuration = "HivCoarseAgeStratification") 
  mod_child <- run_model(parameters, configuration = "ChildModel")

  ## Check that models produce non-zero epidemics
  check_valid_0to1 <- function(x) {
    all(!is.na(x)) &&
      any(x > 0.0) && ## some non-zero
      all(x >= 0) &&
      all(x <= 1) 
  }
  
  expect_true(check_valid_0to1(mod_full$prevalence_15to49_hts))
  ## expect_true(check_valid_0to1(mod_full$artcoverage_15to49_hts))
  expect_true(check_valid_0to1(mod_full$incidence_15to49_hts))

  expect_true(check_valid_0to1(mod_coarse$prevalence_15to49_hts))
  ## expect_true(check_valid_0to1(mod_coarse$artcoverage_15to49_hts))
  expect_true(check_valid_0to1(mod_coarse$incidence_15to49_hts))

  expect_true(check_valid_0to1(mod_child$prevalence_15to49_hts))
  ## expect_true(check_valid_0to1(mod_child$artcoverage_15to49_hts))
  expect_true(check_valid_0to1(mod_child$incidence_15to49_hts))


  ## Check that coarse and full models produce similar epidemics
  ##
  ## Note: these are very close with current test data with no
  ## ART coverage; they will diverge somewhat more when test
  ## data include ART
  expect_true(
    all(abs(mod_full$prevalence_15to49_hts - mod_coarse$prevalence_15to49_hts) < 0.01)
  )
  expect_true(
    all(max(abs(mod_full$incidence_15to49_hts - mod_coarse$incidence_15to49_hts) < 0.001))
  )
  expect_true(
    all(max(abs(mod_full$artcoverage_15to49_hts - mod_coarse$artcoverage_15to49_hts) < 0.001))
  )

  ## Check that end-year prevalence and ART coverage are very close
  ## May not be exactly equal due to end-year migration applied
  prev15to49_full <- colSums(mod_full$p_hivpop[16:50,,],,2) / colSums(mod_full$p_totpop[16:50,,],,2)
  expect_true(
    all(abs(mod_full$prevalence_15to49_hts[10,] - prev15to49_full) < 1e-2)
  )
  
  prev15to49_coarse <- colSums(mod_coarse$p_hivpop[16:50,,],,2) / colSums(mod_coarse$p_totpop[16:50,,],,2)
  expect_true(
    all(abs(mod_coarse$prevalence_15to49_hts[10,] - prev15to49_coarse) < 1e-2)
  )

  prev15to49_child <- colSums(mod_child$p_hivpop[16:50,,],,2) / colSums(mod_child$p_totpop[16:50,,],,2)
  expect_true(
    all(abs(mod_child$prevalence_15to49_hts[10,] - prev15to49_child) < 1e-2)
  )

  prev15to49_full <- colSums(colSums(mod_full$h_artpop[,,1:35,,],,4) / mod_full$p_hivpop[16:50,,],,2)
  expect_true(
    all(abs(mod_full$prevalence_15to49_hts[10,] - prev15to49_full) < 1e-2)
  )
  
  prev15to49_coarse <- colSums(colSums(mod_coarse$h_artpop[,,1:8,,],,4) / mod_coarse$p_hivpop[16:50,,],,2)
  expect_true(
    all(abs(mod_coarse$prevalence_15to49_hts[10,] - prev15to49_coarse) < 1e-2)
  )

  
})
