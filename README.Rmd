---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

options(tidyverse.quiet = TRUE)
```
# leapfrog

<!-- badges: start -->
[![R-CMD-check](https://github.com/mrc-ide/leapfrog/workflows/R-CMD-check/badge.svg)](https://github.com/mrc-ide/leapfrog/actions)
[![Codecov test coverage](https://codecov.io/gh/mrc-ide/leapfrog/branch/master/graph/badge.svg)](https://codecov.io/gh/mrc-ide/leapfrog?branch=master)
<!-- badges: end -->

Leapfrog is a multistate population projection model for demographic and HIV epidemic estimation.

The name _leapfrog_ is in honor of [Professor](https://blogs.lshtm.ac.uk/alumni/2018/07/16/obituary-professor-basia-zaba/) Basia [Zaba](https://translate.google.co.uk/#view=home&op=translate&sl=pl&tl=en&text=%C5%BBaba).

*Note: the CCMPP model and implementation of Bayesian Population Reconstruction in TMB previously here have moved to a separate repository: https://www.github.com/mrc-ide/ccmpp.tmb*

## Installation

Install the development version from [GitHub](https://github.com/mrc-ide/leapfrog) via devtools:

``` r
# install.packages("devtools")
devtools::install_github("mrc-ide/leapfrog")
```

## Example

Construct a sparse Leslie matrix:

```{r example}
library(tidyverse)
library(leapfrog)
library(popReconstruct)

data(burkina_faso_females)

make_leslie_matrixR(sx = burkina.faso.females$survival.proportions[,1],
                    fx = burkina.faso.females$fertility.rates[4:10, 1],
                    srb = 1.05,
                    age_span = 5,
                    fx_idx = 4)
```

Simulate a cohort component population projection:

```{r ccmpp_sim}
pop_proj <- ccmppR(basepop = as.numeric(burkina.faso.females$baseline.pop.counts),
                   sx = burkina.faso.females$survival.proportions,
                   fx = burkina.faso.females$fertility.rates[4:10, ],
                   gx = burkina.faso.females$migration.proportions,
                   srb = rep(1.05, ncol(burkina.faso.females$survival.proportions)),
                   age_span = 5,
                   fx_idx = 4)
pop_proj$population[ , c(1, 2, 10)]

```



## Code design

### Simulation model

The simulation model is implemented as templated C++ code in `src/leapfrog.h`.
This is  the simulation model may be developed as a standalone C++ library
that can be called by other software without requiring R-specific code features.
The code uses header-only open source libraries to maximize portability.



### R functions

The file `src/ccmppR.cpp` contains R wrapper functions for the model simulation 
via [Rcpp](http://dirk.eddelbuettel.com/code/rcpp.html) and 
[RcppEigen](http://dirk.eddelbuettel.com/code/rcpp.eigen.html).


## Development notes

### Simulation model

* The CCMPP model is implemented as a sparse Leslie matrix formulation and using
  direct calculation of the projection in arrays so that interim outputs (deaths,
  births, migrations) are also saved. The array-based implementation appears to 
  be faster.
* Class structure for popualtion projection model needs review.
* Specifying static dimensions for the state space may improve efficiency. This 
  should be possible for common options (5x5 year, 1x1 year) through templating.
* The model was implemented using _Eigen_ containers following the initial sparse
  Leslie matrix specification. However, multi-dimensional arrays in the _boost_
  library may be preferable. 

